import{ItemTypes as e,system as t}from"@minecraft/server";import{world as n}from"@minecraft/server";var r="0.1.0";function i(e){return{dimension:e.dimension.id,x:e.x,y:e.y,z:e.z}}function o(e){return e.dimension.id+Math.floor(e.x).toString()+Math.floor(e.y).toString()+Math.floor(e.z).toString()}function s(e){const t=`fluffyalien_energisticscore:storage${e}`;return n.scoreboard.getObjective(t)}function c(e,t){if(e.hasParticipant(t))return e.getScore(t)}function a(e,t){return`[Bedrock Energistics Core API v${r}] ${e} ${t}`}function f(e){return a("ERROR",e)}import{system as l,world as g}from"@minecraft/server";var u=428,h=30,d=70,p=h+5,m=g.getDimension("overworld"),w=new Map,v=new Map,y=new Map;function $(e){return w.has(e)||v.has(e)||y.has(e)}function _(e){return w.delete(e)}function b(e,t){m.runCommand(`scriptevent ${e} ${t}`)}function E(e,t,n=!1){const r=JSON.stringify(t);if(!n){if(e.length>d)throw new Error(`can't dispatch script event for event '${e}' as the event ID is more than ${d.toString()}`);if(r.length>u)throw new Error(`can't dispatch script event with a message longer than ${u.toString()} characters`)}b(e,r)}var S=0;async function k(e,t,n,r=!1){if(!r&&t.length>h)throw new Error(`can't invoke script event '${e}' using namespace '${t}': '${t}' is longer than ${h.toString()} characters`);const i=`${t}:ipc.__hrl${S.toString()}`;return S++,new Promise(((t,o)=>{const s=l.runTimeout((()=>{_(i),o(new Error(`invoke script event '${e}' timed out: did not recieve a response`))}),20);!function(e,t){if($(e))throw new Error(`can't register script event listener for event '${e}': a listener, stream listener, or handler for this event has already been registered`);if(e.length>d)throw new Error(`can't register listener for event '${e}': '${e}' is longer than ${d.toString()}`);w.set(e,t)}(i,(e=>{_(i),l.clearRun(s),t(e)}));E(e,{re:i,pl:n},r)}))}var O=0;var x=new Map;l.afterEvents.scriptEventReceive.subscribe((e=>{const t=w.get(e.id);if(t)return void t(JSON.parse(e.message));const n=y.get(e.id);if(n){const t=JSON.parse(e.message),r=n(t.pl);E(t.re,r)}if(v.has(e.id)){const[t,n]=e.message.split(/ (.*)/),[r,i]=n.split(/ (.*)/),o="t"===r,s=x.get(t)??"";if(o){x.delete(t);v.get(e.id)(JSON.parse(s+i))}else x.set(t,s+i)}}));var j,M=100,J=6400,N=class{constructor(e){this.internal=e}get id(){return this.internal.a}get persistentEntity(){return this.internal.b??!1}get uiElements(){return this.internal.c}};function z(e){if(j)throw new Error(f("'init' has already been called"));j=e}function R(){if(!j)throw new Error(f("'init' has not been called"))}function I(){return!!e.get("fluffyalien_energisticscore:ui_disabled_storage_bar_segment")}function P(e,r,i=!0){let o;R(),e.handlers?.updateUi&&(o=(r??e.description.id)+"__h0",function(e,t){if($(e))throw new Error(`can't register script event handler for event '${e}': a listener, stream listener, or handler for this event has already been registered`);if(e.length>d)throw new Error(`can't register handler for event '${e}': '${e}' is longer than ${d.toString()}`);y.set(e,t)}(o,(t=>{return e.handlers.updateUi((r=t,{dimension:n.getDimension(r.dimension),x:r.x,y:r.y,z:r.z}));var r})));const s={a:e.description.id,b:e.description.persistentEntity,c:e.description.ui?.elements,d:o};try{E("fluffyalien_energisticscore:ipc.register_machine",s)}catch(n){const r=`caught error when trying to register machine '${e.description.id}': ${n instanceof Error?n.message:"unknown error"}`;if(!i)throw new Error(f(`${r}. falling back to streaming is disabled`));return c=`${r}. falling back to streaming`,console.info(a("INFO",c)),void t.runJob(function*(e,t,n,r=!1){if(!r&&t.length>h)throw new Error(`can't stream script event '${e}' using namespace '${t}': '${t}' is longer than ${h.toString()} characters`);const i=t+O.toString();O++;const o=[JSON.stringify(n)],s=u-p;for(;;){const e=o.at(-1);if(e.length<=s)break;const t=e.slice(0,s),n=e.slice(s);o[o.length-1]=t,n.length&&o.push(n)}for(let t=0;t<o.length;t++){const n=o[t];b(e,`${i} ${t>=o.length-1?"t":"f"} ${n}`),yield}}("fluffyalien_energisticscore:ipc.stream.register_machine",j.namespace,s))}var c}function D(e){R();E("fluffyalien_energisticscore:ipc.register_storage_type",{id:e.id,category:e.category,color:e.color,name:e.name})}function C(e){E("fluffyalien_energisticscore:ipc.update_block_networks",i(e))}function U(e){E("fluffyalien_energisticscore:ipc.update_block_connectable_networks",i(e))}function q(e){E("fluffyalien_energisticscore:ipc.update_block_adjacent_networks",i(e))}function A(e,t){const n=s(t);if(!n)throw new Error(f(`trying to get machine storage of type '${t}' but that storage type does not exist`));return c(n,o(e))??0}function B(e,t,n){if(!e.isValid())throw new Error(f("trying to set machine storage but the block is not valid"));if(n<0)throw new Error(f(`trying to set machine storage of type '${t}' to ${n.toString()} which is less than the minimum value (0)`));if(n>J)throw new Error(f(`trying to set machine storage of type '${t}' to ${n.toString()} which is greater than the maximum value (${J.toString()})`));const r=s(t);if(!r)throw new Error(f(`trying to set machine storage of type '${t}' but that storage type does not exist`));r.setScore(o(e),n)}function F(e,t){const r=o(e),i=c(function(e){const t=`fluffyalien_energisticscore:itemtype${e.toString()}`;return n.scoreboard.getObjective(t)??n.scoreboard.addObjective(t)}(t),r);if(void 0===i)return;const s=c(function(e){const t=`fluffyalien_energisticscore:itemcount${e.toString()}`;return n.scoreboard.getObjective(t)??n.scoreboard.addObjective(t)}(t),r);return s?{typeIndex:i,count:s}:void 0}function T(e,t,n){E("fluffyalien_energisticscore:ipc.set_item_in_machine_slot",{loc:i(e),slot:t,item:n})}function V(e,t,n){E("fluffyalien_energisticscore:ipc.queue_send",{loc:i(e),type:t,amount:n})}function G(e,t,n){const r=A(e,t)+n;r<=0||V(e,t,r)}async function H(e){R();const t=await k("fluffyalien_energisticscore:ipc.get_registered_machine",j.namespace,e);return new N(t)}function K(e){C(e),t.run((()=>{!function(e){const t=o(e);for(const e of n.scoreboard.getObjectives())e.removeParticipant(t)}(e)}))}export{J as MAX_MACHINE_STORAGE,N as RegisteredMachine,M as STORAGE_AMOUNT_PER_BAR_SEGMENT,G as generate,F as getItemInMachineSlot,A as getMachineStorage,H as getRegisteredMachine,z as init,I as isBedrockEnergisticsCoreInWorld,V as queueSend,P as registerMachine,D as registerStorageType,K as removeMachine,T as setItemInMachineSlot,B as setMachineStorage,q as updateBlockAdjacentNetworks,U as updateBlockConnectableNetworks,C as updateBlockNetworks};